name: Auto-Vocab-Daily

on:
  schedule:
    - cron: '0 15 * * *'   # JST 00:00
    - cron: '0 17 * * *'   # JST 02:00
    - cron: '0 19 * * *'   # JST 04:00
    - cron: '0 21 * * *'   # JST 06:00
    - cron: '0 3  * * *'   # JST 12:00
    - cron: '0 6  * * *'   # JST 15:00
    - cron: '0 9  * * *'   # JST 18:00
    - cron: '0 12 * * *'   # JST 21:00
  workflow_dispatch:

concurrency:
  group: auto-vocab-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 540

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ Install requirements
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: ğŸ”‘ Restore YouTube tokens
        env:
          YT_ACC1: ${{ secrets.YT_TOKEN_ACC1 }}
          YT_ACC2: ${{ secrets.YT_TOKEN_ACC2 }}
          YT_ACC3: ${{ secrets.YT_TOKEN_ACC3 }}
          YT_ACC4: ${{ secrets.YT_TOKEN_ACC4 }}
          YT_ACC5: ${{ secrets.YT_TOKEN_ACC5 }}
          YT_ACC6: ${{ secrets.YT_TOKEN_ACC6 }}
          YT_ACC7: ${{ secrets.YT_TOKEN_ACC7 }}   # â† â˜… è¿½åŠ ï¼ˆacc7: koâ†’enï¼‰
        run: |
          set -e
          mkdir -p tokens
          echo "$YT_ACC1" | base64 -d > tokens/token_acc1.pkl
          echo "$YT_ACC2" | base64 -d > tokens/token_acc2.pkl
          echo "$YT_ACC3" | base64 -d > tokens/token_acc3.pkl
          echo "$YT_ACC4" | base64 -d > tokens/token_acc4.pkl
          echo "$YT_ACC5" | base64 -d > tokens/token_acc5.pkl
          echo "$YT_ACC6" | base64 -d > tokens/token_acc6.pkl
          echo "$YT_ACC7" | base64 -d > tokens/token_acc7.pkl  # â† â˜… è¿½åŠ 

      - name: ğŸ¬ Build & Upload All Combos (vocabå°‚ç”¨)
        env:
          OPENAI_API_KEY:      ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          VOCAB_WORDS:         6
          DEBUG_SCRIPT:        "1"
          TARGET_ACCOUNT:      "acc7"  # â† acc7 ã ã‘å‹•ã‹ã—ãŸã„æ™‚ã«ä¸€æ™‚çš„ã«æœ‰åŠ¹åŒ–
        run: |
          python main.py AUTO --privacy public --chunk 999

      - name: â¤´ï¸ Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-temp
          path: |
            temp/script_raw.txt
            temp/script_tts.txt
            temp/subs_table.tsv
            temp/durations.txt
            temp/script_joined.tsv
          if-no-files-found: ignore