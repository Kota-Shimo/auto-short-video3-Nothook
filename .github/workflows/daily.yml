name: Auto-Vocab-Daily

on:
  schedule:
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ÊØéÊó•ÔºàAll days, UTC„Éô„Éº„ÇπÔºâ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - cron: '30 22 * * *'  # JST07:30 ‚Üí ÈÄöÂã§Ââç/ÈÄöÂ≠¶Ââç
    - cron: '15 03 * * *'  # JST12:15 ‚Üí Êòº‰ºë„Åø
    - cron: '30 06 * * *'  # JST15:30 ‚Üí ÊîæË™≤Âæå/‰ºëÊÜ©
    - cron: '30 09 * * *'  # JST18:30 ‚Üí Êó©„ÇÅ„ÅÆÂ∏∞ÂÆÖÂ∏Ø
    - cron: '00 12 * * *'  # JST21:00 ‚Üí „Éó„É©„Ç§„É†Â∏Ø
    - cron: '30 14 * * *'  # JST23:30 ‚Üí ÂØù„ÇãÂâç/Ê∑±Â§úÂã¢

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ÈÄ±Êú´Â¢óÁô∫ÔºàSat=6, Sun=0Ôºâ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - cron: '30 01 * * 6,0'  # JST10:30
    - cron: '00 05 * * 6,0'  # JST14:00
    - cron: '00 10 * * 6,0'  # JST19:00

  workflow_dispatch:
    inputs:
      mode:
        description: "ÂÆüË°å„É¢„Éº„ÉâÔºànormal„ÅÆ„ÅøÈÅãÁî®Ôºâ"
        required: true
        default: "normal"
        type: choice
        options:
          - normal
      target:
        description: "„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÖàÔºàacc1„Äúacc9Ôºâ„ÄÇÁ©∫„Å™„ÇâÂÖ®„Ç¢„Ç´„Ç¶„É≥„Éà"
        required: false
        default: ""

concurrency:
  group: auto-vocab-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 540

    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: üì¶ Install requirements
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          # „É≠„Éº„ÉûÂ≠óÂåñÔºàja-LatnÔºâ„Å´ÂøÖË¶Å
          python -m pip install pykakasi

      - name: üîë Restore YouTube tokens (acc1‚Äìacc9, guard if missing)
        env:
          YT_ACC1: ${{ secrets.YT_TOKEN_ACC1 }}
          YT_ACC2: ${{ secrets.YT_TOKEN_ACC2 }}
          YT_ACC3: ${{ secrets.YT_TOKEN_ACC3 }}
          YT_ACC4: ${{ secrets.YT_TOKEN_ACC4 }}
          YT_ACC5: ${{ secrets.YT_TOKEN_ACC5 }}
          YT_ACC6: ${{ secrets.YT_TOKEN_ACC6 }}
          YT_ACC7: ${{ secrets.YT_TOKEN_ACC7 }}
          YT_ACC8: ${{ secrets.YT_TOKEN_ACC8 }}
          YT_ACC9: ${{ secrets.YT_TOKEN_ACC9 }}
        run: |
          set -euo pipefail
          mkdir -p tokens
          restore_token() {
            local NAME="$1" ; local VAL="$2"
            if [ -n "${VAL:-}" ]; then
              echo "Restoring $NAME ..."
              echo "$VAL" | base64 -d > "tokens/token_${NAME}.pkl"
            else
              echo "Skip $NAME (secret not set)"
            fi
          }
          restore_token acc1 "$YT_ACC1"
          restore_token acc2 "$YT_ACC2"
          restore_token acc3 "$YT_ACC3"
          restore_token acc4 "$YT_ACC4"
          restore_token acc5 "$YT_ACC5"
          restore_token acc6 "$YT_ACC6"
          restore_token acc7 "$YT_ACC7"
          restore_token acc8 "$YT_ACC8"
          restore_token acc9 "$YT_ACC9"

      # ‚òÖ Google Cloud Text-to-SpeechÔºàBase64„Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàÔºâ
      - name: üîê Setup Google credentials (TTS)
        shell: bash
        env:
          GCP_TTS_KEY_B64: ${{ secrets.GCP_TTS_KEY_B64 }}
        run: |
          set -euo pipefail
          if [ -z "${GCP_TTS_KEY_B64:-}" ]; then
            echo "ERROR: secrets.GCP_TTS_KEY_B64 „ÅåÊú™Ë®≠ÂÆö„Åß„Åô„ÄÇ" >&2
            exit 1
          fi
          CRED="$RUNNER_TEMP/google-tts.json"
          echo "::add-mask::$GCP_TTS_KEY_B64"
          echo "$GCP_TTS_KEY_B64" | base64 -d > "$CRED"
          chmod 600 "$CRED"
          python - <<'PY'
          import json, os
          p = os.path.join(os.environ["RUNNER_TEMP"], "google-tts.json")
          with open(p, "r", encoding="utf-8") as f:
              data = json.load(f)
          for k in ("type","project_id","private_key_id","private_key","client_email","client_id"):
              assert k in data, f"missing key: {k}"
          print("OK: credentials JSON looks valid.")
          PY
          {
            echo "GOOGLE_APPLICATION_CREDENTIALS=$CRED"
            echo "TTS_ENGINE_JA=google"
          } >> "$GITHUB_ENV"

      - name: üéô Configure Google TTS voices (optional)
        shell: bash
        run: |
          {
            echo 'GOOGLE_VOICE_POOL_JA=ja-JP-Neural2-B,ja-JP-Neural2-C'
          } >> "$GITHUB_ENV"

      - name: üî§ Subtitle switches (Romaji + Ëã±Ë®≥„ÅÆ3ÊÆµ)
        shell: bash
        run: |
          {
            echo 'SUB_ROMAJI_JA=1'        # 2ÊÆµÁõÆ: ja-Latn „ÇíÂá∫„Åô
            echo 'SUB_JA_ONLY_ROMAJI=0'   # Êó•Êú¨Ë™ûÂéüÊñá„ÇÇÂá∫„ÅôÔºà1ÊÆµÁõÆÔºâ
            echo 'SUB_KANA_JA=0'          # „Åã„Å™Â≠óÂπï„ÅØ„Ç™„Éï
            echo 'FALLBACK_SECOND_SUB=en' # 3ÊÆµÁõÆ„ÅåÁÑ°„ÅÑÊôÇ„ÅØËã±Ë™û„ÅßË£úÂÆå
            # echo 'SUB_ROMAN_KO=1'       # Ôºà‰ªªÊÑèÔºâÈüìÂõΩË™û„ÇÇ„É≠„Éº„ÉûÂ≠óÂåñ„Åó„Åü„ÅÑÂ†¥Âêà
          } >> "$GITHUB_ENV"

      - name: ‚úÖ Print SUB_* envs (for debug)
        shell: bash
        run: |
          printenv | grep -E '^(SUB_|FALLBACK_SECOND_SUB)' || true

      - name: üé¨ Build & Upload All Combos (vocabÂ∞ÇÁî®)
        env:
          OPENAI_API_KEY:      ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          VOCAB_WORDS:         6
          DEBUG_SCRIPT:        "1"
          TARGET_ACCOUNT:      ${{ github.event.inputs.target }}
        run: |
          MODE="AUTO"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.mode }}" = "normal" ]; then
              MODE="AUTO"
            fi
          fi
          echo "‚ñ∂ ÂÆüË°å„É¢„Éº„Éâ: $MODE"
          if [ -z "${TARGET_ACCOUNT:-}" ]; then
            echo "‚ñ∂ ÂÖ®„Ç¢„Ç´„Ç¶„É≥„Éà„ÅßÂÆüË°å"
            python main.py "$MODE" --privacy public --chunk 999
          else
            echo "‚ñ∂ Âçò‰∏Ä„Ç¢„Ç´„Ç¶„É≥„ÉàÂÆüË°å: $TARGET_ACCOUNT"
            python main.py "$MODE" --privacy public --chunk 999 --account "$TARGET_ACCOUNT"
          fi

      - name: ‚§¥Ô∏è Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-temp
          path: |
            temp/script_raw.txt
            temp/script_tts.txt
            temp/subs_table.tsv
            temp/durations.txt
            temp/script_joined.tsv
            temp/spec.json
          if-no-files-found: ignore