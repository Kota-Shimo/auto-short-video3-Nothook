name: Auto-Vocab-Daily

on:
  schedule:
    - cron: '0 0  * * *'   # JST09:00 â†’ é€šå¸¸
    #- cron: '0 1  * * *'   # JST10:00 â†’ â˜…ãƒˆãƒ¬ãƒ³ãƒ‰
    - cron: '0 3  * * *'   # JST12:00 â†’ é€šå¸¸
    - cron: '0 6  * * *'   # JST15:00 â†’ é€šå¸¸
    - cron: '0 9  * * *'   # JST18:00 â†’ é€šå¸¸
    - cron: '0 12 * * *'   # JST21:00 â†’ é€šå¸¸
    #- cron: '0 13 * * *'   # JST22:00 â†’ â˜…ãƒˆãƒ¬ãƒ³ãƒ‰
    - cron: '0 15 * * *'   # JST00:00 â†’ é€šå¸¸
    - cron: '0 18 * * *'   # JST03:00 â†’ é€šå¸¸
    - cron: '0 21 * * *'   # JST06:00 â†’ é€šå¸¸
  workflow_dispatch:
    inputs:
      mode:
        description: "å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ï¼ˆnormal=é€šå¸¸ / trend=ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰"
        required: true
        default: "trend"
        type: choice
        options:
          - normal
          - trend
      target:
        description: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆï¼ˆacc1ã€œacc9ï¼‰ã€‚ç©ºãªã‚‰å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"
        required: false
        default: ""

concurrency:
  group: auto-vocab-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 540

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ Install requirements
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: ğŸ”‘ Restore YouTube tokens (acc1â€“acc9, guard if missing)
        env:
          YT_ACC1: ${{ secrets.YT_TOKEN_ACC1 }}
          YT_ACC2: ${{ secrets.YT_TOKEN_ACC2 }}
          YT_ACC3: ${{ secrets.YT_TOKEN_ACC3 }}
          YT_ACC4: ${{ secrets.YT_TOKEN_ACC4 }}
          YT_ACC5: ${{ secrets.YT_TOKEN_ACC5 }}
          YT_ACC6: ${{ secrets.YT_TOKEN_ACC6 }}
          YT_ACC7: ${{ secrets.YT_TOKEN_ACC7 }}
          YT_ACC8: ${{ secrets.YT_TOKEN_ACC8 }}
          YT_ACC9: ${{ secrets.YT_TOKEN_ACC9 }}
        run: |
          set -euo pipefail
          mkdir -p tokens

          restore_token() {
            local NAME="$1" ; local VAL="$2"
            if [ -n "${VAL:-}" ]; then
              echo "Restoring $NAME ..."
              echo "$VAL" | base64 -d > "tokens/token_${NAME}.pkl"
            else
              echo "Skip $NAME (secret not set)"
            fi
          }

          restore_token acc1 "$YT_ACC1"
          restore_token acc2 "$YT_ACC2"
          restore_token acc3 "$YT_ACC3"
          restore_token acc4 "$YT_ACC4"
          restore_token acc5 "$YT_ACC5"
          restore_token acc6 "$YT_ACC6"
          restore_token acc7 "$YT_ACC7"
          restore_token acc8 "$YT_ACC8"
          restore_token acc9 "$YT_ACC9"

      - name: ğŸ¬ Build & Upload All Combos (vocabå°‚ç”¨)
        env:
          OPENAI_API_KEY:      ${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          VOCAB_WORDS:         6
          DEBUG_SCRIPT:        "1"
          TARGET_ACCOUNT:      ${{ github.event.inputs.target }}
        run: |
          MODE="AUTO"
          # æ‰‹å‹•å®Ÿè¡Œãªã‚‰ mode é¸æŠã‚’åæ˜ 
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.mode }}" = "trend" ]; then
              MODE="AUTO_TREND"
            fi
          else
            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚ï¼šUTC1:00 or 13:00ï¼ˆï¼JST10:00/22:00ï¼‰ã ã‘ãƒˆãƒ¬ãƒ³ãƒ‰
            HOUR=$(date -u +%H)
            if [ "$HOUR" = "1" ] || [ "$HOUR" = "13" ]; then
              MODE="AUTO_TREND"
            fi
          fi

          echo "â–¶ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: $MODE"

          # targetæœªå…¥åŠ›ãªã‚‰å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‡¦ç†
          if [ -z "${TARGET_ACCOUNT:-}" ]; then
            echo "â–¶ å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å®Ÿè¡Œ"
            python main.py "$MODE" --privacy public --chunk 999
          else
            echo "â–¶ å˜ä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå®Ÿè¡Œ: $TARGET_ACCOUNT"
            python main.py "$MODE" --privacy public --chunk 999 --account "$TARGET_ACCOUNT"
          fi

      - name: â¤´ï¸ Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-temp
          path: |
            temp/script_raw.txt
            temp/script_tts.txt
            temp/subs_table.tsv
            temp/durations.txt
            temp/script_joined.tsv
            temp/spec.json
          if-no-files-found: ignore